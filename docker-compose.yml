# ==================================================
# ToolDock Docker Compose
# ==================================================
#
# Zwei separate Container - immer getrennt:
#   - tooldock-backend: Python Backend (OpenAPI, MCP, API)
#   - tooldock-admin: React Frontend (Admin UI)
#
# Ports (konfigurierbar in .env):
#   - 8006: OpenAPI/REST
#   - 8007: MCP HTTP
#   - 8080: Backend API
#   - 3000: Admin UI
#
# Nutzung:
#   docker compose up -d
#   docker compose logs -f
#
# ==================================================

services:
  # ============================================
  # Backend: Python (FastAPI)
  # Separate Image: tooldock-backend:latest
  # ============================================
  tooldock-backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: tooldock-backend:latest
    container_name: tooldock-backend
    env_file:
      - .env
    environment:
      - SERVER_MODE=all
      - DATA_DIR=/data
      - HOST=0.0.0.0
      - CORS_ORIGINS=*
      # Internal container ports are fixed - only host ports are configurable
      - OPENAPI_PORT=8006
      - MCP_PORT=8007
      - WEB_PORT=8080
      # Public/host ports (used for UI display and links)
      - OPENAPI_PUBLIC_PORT=${OPENAPI_PORT:-18006}
      - MCP_PUBLIC_PORT=${MCP_PORT:-18007}
      - WEB_PUBLIC_PORT=${WEB_PORT:-18080}
      - HOST_DATA_DIR=${HOST_DATA_DIR:-./tooldock_data}
    ports:
      # Host:Container - host ports from .env, container ports fixed
      - "${OPENAPI_PORT:-18006}:8006"
      - "${MCP_PORT:-18007}:8007"
      - "${WEB_PORT:-18080}:8080"
    volumes:
      - ./tooldock_data:/data:rw
    restart: unless-stopped
    networks:
      - tooldock-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      # Uses fixed internal port (8007)
      test: ["CMD", "curl", "-f", "http://localhost:8007/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # Admin UI: React (Nginx)
  # Separate Image: tooldock-admin:latest
  # ============================================
  tooldock-admin:
    build:
      context: ./admin-ui
      dockerfile: Dockerfile
    image: tooldock-admin:latest
    container_name: tooldock-admin
    ports:
      - "${ADMIN_PORT:-13000}:80"
    restart: unless-stopped
    networks:
      - tooldock-network
    depends_on:
      tooldock-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

networks:
  tooldock-network:
    driver: bridge
