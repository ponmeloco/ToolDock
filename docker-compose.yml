# ==================================================
# ToolDock Docker Compose
# ==================================================
#
# Zwei separate Container - immer getrennt:
#   - tooldock-backend: Python Backend (OpenAPI, MCP, API)
#   - tooldock-admin: React Frontend (Admin UI)
#
# Ports (konfigurierbar in .env):
#   - 8006: OpenAPI/REST
#   - 8007: MCP HTTP
#   - 8080: Backend API
#   - 3000: Admin UI
#
# Nutzung:
#   docker compose up -d
#   docker compose logs -f
#
# ==================================================

services:
  # ============================================
  # Backend: Python (FastAPI)
  # Separate Image: tooldock-backend:latest
  # ============================================
  tooldock-backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: tooldock-backend:latest
    container_name: tooldock-backend
    env_file:
      - .env
    environment:
      - SERVER_MODE=all
      - DATA_DIR=/data
      - HOST=0.0.0.0
    ports:
      - "${OPENAPI_PORT:-8006}:${OPENAPI_PORT:-8006}"
      - "${MCP_PORT:-8007}:${MCP_PORT:-8007}"
      - "${WEB_PORT:-8080}:${WEB_PORT:-8080}"
    volumes:
      - ./tooldock_data:/data:rw
    restart: unless-stopped
    networks:
      - tooldock-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8007/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # Admin UI: React (Nginx)
  # Separate Image: tooldock-admin:latest
  # ============================================
  tooldock-admin:
    build:
      context: ./admin-ui
      dockerfile: Dockerfile
    image: tooldock-admin:latest
    container_name: tooldock-admin
    ports:
      - "${ADMIN_PORT:-3000}:80"
    restart: unless-stopped
    networks:
      - tooldock-network
    depends_on:
      tooldock-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

networks:
  tooldock-network:
    driver: bridge
