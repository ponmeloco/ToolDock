# ==================================================
# ToolDock Docker Compose
# ==================================================
#
# Zwei separate Container - immer getrennt:
#   - tooldock-backend: Python Backend (OpenAPI, MCP, API)
#   - tooldock-gateway: React Frontend + reverse proxy gateway
#
# Ports (konfigurierbar in .env):
#   - 13000: Admin UI gateway (single exposed port)
# Internal-only ports in backend container:
#   - 8006: Tool API (OpenAPI transport)
#   - 8007: MCP HTTP transport
#   - 8080: Backend API
#
# Nutzung:
#   docker compose up -d
#   docker compose logs -f
#
# ==================================================

services:
  # ============================================
  # Backend: Python (FastAPI)
  # Separate Image: tooldock-backend:latest
  # ============================================
  tooldock-backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: tooldock-backend:latest
    container_name: tooldock-backend
    env_file:
      - .env
    environment:
      - SERVER_MODE=all
      - DATA_DIR=/data
      - DATABASE_URL=${DATABASE_URL:-sqlite:////data/db/tooldock.db}
      - HOST=0.0.0.0
      - CORS_ORIGINS=*
      # Internal container ports are fixed - only host ports are configurable
      - OPENAPI_PORT=8006
      - MCP_PORT=8007
      - WEB_PORT=8080
      # Public port is the Admin UI gateway
      - OPENAPI_PUBLIC_PORT=${ADMIN_PORT:-13000}
      - MCP_PUBLIC_PORT=${ADMIN_PORT:-13000}
      - WEB_PUBLIC_PORT=${ADMIN_PORT:-13000}
      - HOST_DATA_DIR=${HOST_DATA_DIR:-./tooldock_data}
    expose:
      - "8006"
      - "8007"
      - "8080"
    volumes:
      - ./tooldock_data:/data:rw
    restart: unless-stopped
    networks:
      - tooldock-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      # Uses fixed internal port (8007)
      test: ["CMD", "curl", "-f", "http://localhost:8007/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # Gateway UI: React (Nginx)
  # Separate Image: tooldock-gateway:latest
  # ============================================
  tooldock-gateway:
    build:
      context: ./admin-ui
      dockerfile: Dockerfile
    image: tooldock-gateway:latest
    container_name: tooldock-gateway
    ports:
      - "${ADMIN_PORT:-13000}:80"
    restart: unless-stopped
    networks:
      - tooldock-network
    depends_on:
      tooldock-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

networks:
  tooldock-network:
    driver: bridge
