# ==================================================
# OmniMCP Docker Compose
# ==================================================
#
# Nutzung:
#   docker compose up -d                    → Alles in einem Container
#   docker compose --profile split up -d    → Getrennte Container
#
# Ports (konfigurierbar in .env):
#   - 8006: OpenAPI/REST
#   - 8007: MCP HTTP
#   - 8080: Web GUI
#
# ==================================================

services:
  # ============================================
  # All-in-One: MCP + OpenAPI + Web GUI
  # ============================================
  omnimcp:
    build: .
    image: omnimcp:latest
    container_name: omnimcp
    env_file:
      - .env
    environment:
      - SERVER_MODE=all
      - DATA_DIR=/data
      - HOST=0.0.0.0
    ports:
      - "${OPENAPI_PORT:-8006}:${OPENAPI_PORT:-8006}"
      - "${MCP_PORT:-8007}:${MCP_PORT:-8007}"
      - "${WEB_PORT:-8080}:${WEB_PORT:-8080}"
    volumes:
      - ./omnimcp_data:/data
    restart: unless-stopped
    networks:
      - tool-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:$${MCP_PORT:-8007}/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Getrennte Container (Optional)
  # Start: docker compose --profile split up -d
  # ============================================
  omnimcp-server:
    build: .
    image: omnimcp:latest
    container_name: omnimcp-server
    env_file:
      - .env
    environment:
      - SERVER_MODE=both
      - DATA_DIR=/data
      - HOST=0.0.0.0
    ports:
      - "${OPENAPI_PORT:-8006}:${OPENAPI_PORT:-8006}"
      - "${MCP_PORT:-8007}:${MCP_PORT:-8007}"
    volumes:
      - ./omnimcp_data:/data
    restart: unless-stopped
    networks:
      - tool-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    profiles:
      - split
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:$${MCP_PORT:-8007}/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  omnimcp-web:
    build: .
    image: omnimcp:latest
    container_name: omnimcp-web
    env_file:
      - .env
    environment:
      - SERVER_MODE=web-gui
      - DATA_DIR=/data
      - HOST=0.0.0.0
    ports:
      - "${WEB_PORT:-8080}:${WEB_PORT:-8080}"
    volumes:
      - ./omnimcp_data:/data
    restart: unless-stopped
    networks:
      - tool-network
    profiles:
      - split
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:$${WEB_PORT:-8080}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - omnimcp-server

networks:
  tool-network:
    driver: bridge
