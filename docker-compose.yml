services:
  # ============================================
  # OpenAPI Server for OpenWebUI
  # ============================================
  tool-server-openapi:
    build: .
    image: omnimcp:latest
    container_name: omnimcp-openapi
    environment:
      - SERVER_MODE=openapi
      - TOOLS_DIR=/app/tools
      - EXTERNAL_CONFIG=/app/tools/external/config.yaml
      - OPENAPI_SERVER_NAME=tools-openapi
      - REGISTRY_NAMESPACE=shared
      - BEARER_TOKEN=${BEARER_TOKEN:-change_me_openapi}
      - OPENAPI_PORT=8006
      # Pass through tokens for external servers
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
    ports:
      - "8006:8006"
    volumes:
      - ./tools:/app/tools
    restart: unless-stopped
    networks:
      - tool-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # MCP Streamable HTTP Server for MCP Clients
  # ============================================
  tool-server-mcp-http:
    build: .
    image: omnimcp:latest
    container_name: omnimcp-mcp
    environment:
      - SERVER_MODE=mcp-http
      - TOOLS_DIR=/app/tools
      - EXTERNAL_CONFIG=/app/tools/external/config.yaml
      - MCP_SERVER_NAME=mcp-tools
      - REGISTRY_NAMESPACE=shared
      - MCP_PORT=8007
      # Pass through tokens for external servers
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
    ports:
      - "8007:8007"
    volumes:
      - ./tools:/app/tools
    restart: unless-stopped
    networks:
      - tool-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8007/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Combined: Both servers in one container
  # Start with: docker compose --profile combined up tool-server-both
  # ============================================
  tool-server-both:
    build: .
    image: omnimcp:latest
    container_name: omnimcp-both
    environment:
      - SERVER_MODE=both
      - TOOLS_DIR=/app/tools
      - EXTERNAL_CONFIG=/app/tools/external/config.yaml
      - OPENAPI_SERVER_NAME=tools-openapi
      - MCP_SERVER_NAME=mcp-tools
      - REGISTRY_NAMESPACE=shared
      - BEARER_TOKEN=${BEARER_TOKEN:-change_me}
      - OPENAPI_PORT=8006
      - MCP_PORT=8007
      # Pass through tokens for external servers
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
    ports:
      - "8006:8006"
      - "8007:8007"
    volumes:
      - ./tools:/app/tools
    restart: unless-stopped
    networks:
      - tool-network
    profiles:
      - combined
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health", "&&", "curl", "-f", "http://localhost:8007/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  tool-network:
    driver: bridge
