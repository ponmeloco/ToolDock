name: tooldock-local

services:
  tooldock-core:
    container_name: tooldock-core
    image: tooldock-core
    build:
      context: .
      dockerfile: core/Dockerfile
    ports:
      - "${CORE_PORT:-8000}:8000"
    volumes:
      - ./.tooldock-data:/data
    env_file: .env
    environment:
      - MANAGER_INTERNAL_TOKEN=${MANAGER_INTERNAL_TOKEN}
      - ENABLE_LEGACY_MCP=${ENABLE_LEGACY_MCP:-true}
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=2)",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  tooldock-manager:
    container_name: tooldock-manager
    image: tooldock-manager
    build:
      context: .
      dockerfile: manager/Dockerfile
    ports:
      - "${MANAGER_PORT:-8001}:8001"
    volumes:
      - ./.tooldock-data:/data
    tmpfs:
      - /dev/shm
    env_file: .env
    environment:
      - CORE_URL=http://tooldock-core:8000
      - MANAGER_INTERNAL_TOKEN=${MANAGER_INTERNAL_TOKEN}
      - ENABLE_LEGACY_MCP=${ENABLE_LEGACY_MCP:-true}
      - ENABLE_FS_WATCHER=${ENABLE_FS_WATCHER:-false}
      - FS_WATCHER_DEBOUNCE_MS=${FS_WATCHER_DEBOUNCE_MS:-1500}
    depends_on:
      tooldock-core:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8001/health', timeout=2)",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
